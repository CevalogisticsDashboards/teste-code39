<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escaneador de Códigos com ZXing</title>
    <!-- Incluindo a biblioteca ZXing via CDN -->
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        #video {
            width: 100%;
            max-width: 500px;
            height: auto;
            position: relative;
        }
        #result {
            width: 90%;
            margin: 10px auto;
            padding: 10px;
            font-size: 16px;
        }
        #startButton {
            padding: 10px 20px;
            font-size: 16px;
            margin: 10px;
        }
        /* Quadrado de alinhamento */
        .scan-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 20%;
            border: 2px dashed red;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <h2>Escaneador de Códigos de Barras</h2>
    <!-- Campo de texto para o resultado -->
    <input type="text" id="result" placeholder="Resultado aparecerá aqui" readonly>
    <!-- Botão para iniciar o escaneamento -->
    <button id="startButton">Iniciar Escaneamento</button>
    <!-- Vídeo para exibir a câmera -->
    <video id="video" muted playsinline></video>

    <!-- Configuração do PWA -->
    <link rel="manifest" href="manifest.json">
    <script>
        // Registro do Service Worker para PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(() => console.log('Service Worker registrado'))
                .catch(err => console.error('Erro ao registrar Service Worker:', err));
        }

        // JavaScript para o escaneamento
        document.addEventListener('DOMContentLoaded', () => {
            const video = document.getElementById('video');
            const resultInput = document.getElementById('result');
            const startButton = document.getElementById('startButton');
            let codeReader = null;
            let stream = null;

            // Função para parar o escaneamento
            function stopScanning() {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
            }

            // Função para iniciar o escaneamento
            async function startScanning() {
                stopScanning(); // Para qualquer escaneamento ativo

                codeReader = new ZXing.BrowserMultiFormatReader();
                try {
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'environment' } // Usa a câmera traseira
                    });
                    video.srcObject = stream;
                    video.play();

                    // Adiciona o quadrado de alinhamento
                    if (!document.querySelector('.scan-area')) {
                        const scanArea = document.createElement('div');
                        scanArea.className = 'scan-area';
                        video.parentNode.insertBefore(scanArea, video.nextSibling);
                    }

                    // Inicia a leitura
                    codeReader.decodeFromVideoDevice(null, 'video', (result, err) => {
                        if (result) {
                            resultInput.value = result.text;
                            stopScanning();
                            codeReader.reset();
                        }
                        if (err && !(err instanceof ZXing.NotFoundException)) {
                            console.error('Erro no escaneamento:', err);
                        }
                    });
                } catch (err) {
                    console.error('Erro ao acessar a câmera:', err);
                    alert('Não foi possível acessar a câmera. Verifique as permissões.');
                }
            }

            // Evento do botão
            startButton.addEventListener('click', startScanning);
        });
    </script>
</body>
</html>
