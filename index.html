<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escaneador de Códigos</title>
    <!-- Incluindo a biblioteca ZXing via CDN -->
    <script src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>
</head>
<body>
    <!-- Campo de texto para exibir o resultado -->
    <input type="text" id="result" placeholder="Digite ou escaneie um código">
    <!-- Botão para iniciar o escaneamento -->
    <button id="scanButton">Escanear</button>
    <!-- Elemento de vídeo para exibir o stream da câmera -->
    <video id="video" width="100%" height="auto" style="border:1px solid black"></video>

    <!-- JavaScript embutido -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const resultInput = document.getElementById('result');
            const scanButton = document.getElementById('scanButton');
            const videoElement = document.getElementById('video');
            let codeReader = null;

            // Função para parar o escaneamento
            function stopScanning() {
                if (codeReader) {
                    codeReader.reset();
                    codeReader = null;
                }
            }

            // Função para iniciar o escaneamento
            async function startScanning() {
                stopScanning(); // Garante que não há escaneamento ativo
                codeReader = new ZXing.BrowserMultiFormatReader();

                try {
                    // Tenta usar a câmera traseira (environment)
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');
                    let deviceId = undefined;

                    // Procura pela câmera traseira
                    for (const device of videoDevices) {
                        if (device.label.toLowerCase().includes('back') || device.label.toLowerCase().includes('rear')) {
                            deviceId = device.deviceId;
                            break;
                        }
                    }

                    // Inicia o escaneamento
                    codeReader.decodeFromVideoDevice(deviceId, videoElement, (result, err) => {
                        if (result) {
                            resultInput.value = result.text;
                            stopScanning();
                        }
                        if (err && !(err instanceof ZXing.NotFoundException)) {
                            console.error('Erro:', err);
                        }
                    });
                } catch (err) {
                    console.error('Erro ao acessar a câmera:', err);
                    alert('Não foi possível acessar a câmera. Verifique as permissões.');
                }
            }

            // Evento do botão
            scanButton.addEventListener('click', startScanning);
        });
    </script>
</body>
</html>
